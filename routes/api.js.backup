import express from "express"; // Importe Express pour cr√©er le routeur// ===================================
// üìÇ ROUTES POUR LES CAT√âGORIES
// ===================================
router.get("/categories", categoryController.getAllCategories); // Liste toutes les cat√©gories
router.get("/categories/:id", categoryController.getCategoryById); // R√©cup√®re une cat√©gorie sp√©cifique
router.post("/categories", checkJwt, categoryController.createCategory); // Cr√©ation d'une cat√©gorie (prot√©g√©)
router.put("/categories/:id", checkJwt, categoryController.updateCategory); // Mise √† jour (prot√©g√©)
router.delete("/categories/:id", checkJwt, categoryController.deleteCategory); // Suppression (prot√©g√©)

// ===================================
// üõí ROUTES POUR LE PANIER
// ===================================
router.get("/cart", checkJwt, cartController.getCart); // R√©cup√®re le panier de l'utilisateur (prot√©g√©)
router.post("/cart/items", checkJwt, cartController.addToCart); // Ajoute un article au panier (prot√©g√©)
router.put("/cart/items/:id", checkJwt, cartController.updateCartItem); // Met √† jour un article du panier (prot√©g√©)
router.delete("/cart/items/:id", checkJwt, cartController.removeFromCart); // Supprime un article du panier (prot√©g√©)
router.get("/cart/count", checkJwt, cartController.getCartCount); // R√©cup√®re le nombre d'articles dans le panier (prot√©g√©)

// ===================================
//  ROUTES POUR LES COMMANDES
// ===================================
router.post("/orders", checkJwt, orderController.createOrder); // Cr√©ation d'une commande (prot√©g√©)
router.get("/orders", checkJwt, orderController.getUserOrders); // R√©cup√®re les commandes de l'utilisateur (prot√©g√©)
router.get("/orders/:order_id", checkJwt, orderController.getOrderDetails); // R√©cup√®re une commande sp√©cifique (prot√©g√©)

// === EXPORT DU ROUTEUR POUR L'UTILISER DANS server.js ===
export default router;t * as authController from "../controllers/authController.js"; // Contr√¥leur d'authentification
import * as productSupabaseController from "../controllers/productSupabaseController.js"; // üöÄ NOUVEAU : Contr√¥leur produits Supabase (remplace productController)
import * as categoryController from "../controllers/categoryController.js"; // Contr√¥leur cat√©gories
import * as cartController from "../controllers/cartController.js"; // Contr√¥leur panier
import * as orderController from "../controllers/orderController.js"; // Contr√¥leur commandes
import * as testController from "../controllers/testController.js"; // Contr√¥leur de test
import checkJwt from "../middleware/checkJwt.js"; // Middleware JWT pour prot√©ger les routes
import jwt from "jsonwebtoken"; // Import de jsonwebtoken pour la gestion des tokens JWT

const router = express.Router(); // Cr√©e un routeur Express

// === ROUTES DE TEST ===
router.get("/test/connection", testController.testConnection); // Test connexion Supabase
router.get("/test/tables", testController.listTables); // Liste des tables disponibles

// === ROUTES D'AUTHENTIFICATION ===
router.post("/auth/register", authController.register); // Inscription d'un utilisateur
router.post("/auth/login", authController.login); // Connexion et obtention du token JWT
router.post("/auth/logout", authController.logout); // D√©connexion utilisateur
router.get("/auth/me", authController.getCurrentUser); // R√©cup√©ration de l'utilisateur actuel

// ===================================
//  ROUTES POUR LES PRODUITS - Version Supabase Avanc√©e
// Remplace l'ancien productController par productSupabaseController
// Nouvelles fonctionnalit√©s : pagination, filtres, recherche, slugs SEO
// ===================================

// ROUTE PRINCIPALE : Liste des produits avec filtres et pagination
// Exemples d'utilisation :
// GET /api/products                                    ‚Üí Tous les produits (page 1, 10 par page)
// GET /api/products?page=2&limit=20                    ‚Üí Page 2, 20 produits par page
// GET /api/products?category=guitares                  ‚Üí Seulement les guitares
// GET /api/products?brand=fender&min_price=500         ‚Üí Marque Fender, prix min 500‚Ç¨
// GET /api/products?search=stratocaster                ‚Üí Recherche "stratocaster"
router.get("/products", productSupabaseController.getAllProducts);

//  ROUTE PRODUITS FEATURED : Produits mis en avant
// GET /api/products/featured?limit=6                   ‚Üí 6 produits featured (d√©faut)
// GET /api/products/featured?limit=12                  ‚Üí 12 produits featured
router.get("/products/featured", productSupabaseController.getFeaturedProducts);

//  ROUTE RECHERCHE : Recherche textuelle rapide
// GET /api/products/search?q=guitare&limit=10          ‚Üí Recherche "guitare", max 10 r√©sultats
// GET /api/products/search?q=gibson                    ‚Üí Recherche "gibson"
router.get("/products/search", productSupabaseController.searchProducts);

//  ROUTE PRODUIT INDIVIDUEL : R√©cup√©ration par slug (SEO-friendly)
// GET /api/products/gibson-les-paul-standard-2024      ‚Üí Produit via slug
// GET /api/products/fender-stratocaster-american       ‚Üí Autre exemple
// IMPORTANT : Cette route doit √™tre EN DERNIER pour √©viter les conflits avec "featured" et "search"
router.get("/products/:slug", productSupabaseController.getProductBySlug);

// === ROUTES POUR LES PRODUITS === "express"; // Importe Express pour cr√©er le routeur
import * as authController from "../controllers/authController.js"; // Contr√¥leur d'authentification
import * as productController from "../controllers/productController.js"; // Contr√¥leur produits
import * as categoryController from "../controllers/categoryController.js"; // Contr√¥leur cat√©gories
import * as cartController from "../controllers/cartController.js"; // Contr√¥leur panier
import * as orderController from "../controllers/orderController.js"; // Contr√¥leur commandes
import * as testController from "../controllers/testController.js"; // Contr√¥leur de test
import checkJwt from "../middleware/checkJwt.js"; // Middleware JWT pour prot√©ger les routes
import jwt from "jsonwebtoken"; // Import de jsonwebtoken pour la gestion des tokens JWT

// === ROUTES DE TEST ===
router.get("/test/connection", testController.testConnection); // Test connexion Supabase
router.get("/test/tables", testController.listTables); // Liste des tables disponibles

// === ROUTES D'AUTHENTIFICATION ===
router.post("/auth/register", authController.register); // Inscription d‚Äôun utilisateur
router.post("/auth/login", authController.login); // Connexion et obtention du token JWT

// === ROUTES POUR LES PRODUITS ===
router.get("/products", productController.getAllProducts); // Liste tous les produits
router.get("/products/:id", productController.getProductById); // R√©cup√®re un produit sp√©cifique par ID
router.post("/products", checkJwt, productController.addProduct); // Cr√©ation d‚Äôun produit (prot√©g√©)
router.put("/products/:id", checkJwt, productController.updateProduct); // Modification d‚Äôun produit (prot√©g√©)
router.delete("/products/:id", checkJwt, productController.deleteProduct); // Suppression d‚Äôun produit (prot√©g√©)

// === ROUTES POUR LES CAT√âGORIES ===
router.get("/categories", categoryController.getAllCategories); // Liste toutes les cat√©gories
router.get("/categories/:id", categoryController.getCategoryById); // R√©cup√®re une cat√©gorie sp√©cifique
router.post("/categories", checkJwt, categoryController.createCategory); // Cr√©ation d‚Äôune cat√©gorie (prot√©g√©)
router.put("/categories/:id", checkJwt, categoryController.updateCategory); // Mise √† jour (prot√©g√©)
router.delete("/categories/:id", checkJwt, categoryController.deleteCategory); // Suppression (prot√©g√©)

// === ROUTES POUR LE PANIER ===
router.get("/cart", checkJwt, cartController.getCart); // R√©cup√®re le panier de l'utilisateur (prot√©g√©)
router.post("/cart/items", checkJwt, cartController.addToCart); // Ajoute un article au panier (prot√©g√©)
router.put("/cart/items/:id", checkJwt, cartController.updateCartItem); // Met √† jour un article du panier (prot√©g√©)
router.delete("/cart/items/:id", checkJwt, cartController.removeFromCart); // Supprime un article du panier (prot√©g√©)
router.get("/cart/count", checkJwt, cartController.getCartCount); // R√©cup√®re le nombre d'articles dans le panier (prot√©g√©)

// === ROUTES POUR LES COMMANDES ===
router.post("/orders", checkJwt, orderController.createOrder); // Cr√©ation d'une commande (prot√©g√©)
router.get("/orders", checkJwt, orderController.getUserOrders); // R√©cup√®re les commandes de l'utilisateur (prot√©g√©)
router.get("/orders/:order_id", checkJwt, orderController.getOrderDetails); // R√©cup√®re une commande sp√©cifique (prot√©g√©)

// route de connexion (login) pour les utilisateurs
router.post("/login", (req, res) => {
  const { username, password } = req.body;
  // √† remplacer par la logique r√©elle pplus tard
  if (username === "admin" && password === "admin") {
    // G√©n√©ration d'un token JWT
    const token = jwt.sign({ username }, "votre_cl√©_secr√®te_jwt", {
      expiresIn: "1h",
    });
    res.json({ token }); // Envoie le token au client
  } else {
    res.status(401).json({ message: "Identifiants invalides" }); // En cas d'√©chec
  }
});
// === EXPORT DU ROUTEUR POUR L‚ÄôUTILISER DANS server.js ===
export default router;
